<!DOCTYPE html>
<html>
<head>
    <title>Evently Load Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; }
        .button { padding: 10px 20px; margin: 10px; background: #007bff; color: white; border: none; cursor: pointer; }
        .results { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .metric-card { background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Evently Load Testing Dashboard</h1>
        
        <div>
            <button class="button" onclick="testLoadBalancing()">Test Load Balancing (10 requests)</button>
            <button class="button" onclick="testConcurrentBooking()">Test Concurrent Booking (20 requests)</button>
            <button class="button" onclick="getMetrics()">Get Performance Metrics</button>
            <button class="button" onclick="clearResults()">Clear Results</button>
        </div>

        <div id="results" class="results"></div>
        
        <div id="metrics" class="metrics"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        
        async function testLoadBalancing() {
            showLoading('Testing load balancing...');
            const promises = [];
            
            for (let i = 0; i < 10; i++) {
                promises.push(fetch(`${API_BASE}/api/test-instance`));
            }
            
            try {
                const responses = await Promise.all(promises);
                const results = await Promise.all(responses.map(r => r.json()));
                
                const instances = new Set(results.map(r => r.instanceId));
                
                showResults(`
                    <h3>‚úÖ Load Balancing Test Results</h3>
                    <p><strong>Requests sent:</strong> 10</p>
                    <p><strong>Instances used:</strong> ${instances.size}</p>
                    <p><strong>Instance IDs:</strong> ${Array.from(instances).join(', ')}</p>
                    <p><strong>Load balancing:</strong> ${instances.size > 1 ? '‚úÖ Working' : '‚ùå Not working'}</p>
                `);
            } catch (error) {
                showResults(`<h3>‚ùå Error:</h3><p>${error.message}</p>`);
            }
        }
        
        async function testConcurrentBooking() {
            const userToken = prompt('Enter your user JWT token:');
            const eventId = prompt('Enter event ID:');
            
            if (!userToken || !eventId) {
                alert('Token and Event ID are required');
                return;
            }
            
            showLoading('Testing concurrent booking...');
            const promises = [];
            
            for (let i = 0; i < 20; i++) {
                promises.push(
                    fetch(`${API_BASE}/api/bookings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            eventId: eventId,
                            quantity: 1
                        })
                    })
                );
            }
            
            try {
                const responses = await Promise.all(promises);
                
                let successful = 0;
                let failed = 0;
                let queued = 0;
                
                for (const response of responses) {
                    if (response.ok) {
                        const data = await response.json();
                        if (data.data?.status === 'queued') {
                            queued++;
                        } else {
                            successful++;
                        }
                    } else {
                        failed++;
                    }
                }
                
                showResults(`
                    <h3>üî• Concurrent Booking Test Results</h3>
                    <p><strong>Total requests:</strong> 20</p>
                    <p><strong>Successful:</strong> ${successful}</p>
                    <p><strong>Queued:</strong> ${queued}</p>
                    <p><strong>Failed:</strong> ${failed}</p>
                    <p><strong>Success rate:</strong> ${((successful + queued) / 20 * 100).toFixed(1)}%</p>
                `);
            } catch (error) {
                showResults(`<h3>‚ùå Error:</h3><p>${error.message}</p>`);
            }
        }
        
        async function getMetrics() {
            try {
                const response = await fetch(`${API_BASE}/api/metrics/performance`);
                const data = await response.json();
                
                const metrics = data.data;
                
                document.getElementById('metrics').innerHTML = `
                    <div class="metric-card">
                        <h4>üìä Request Metrics</h4>
                        <p>Total: ${metrics.requests.total}</p>
                        <p>Successful: ${metrics.requests.successful}</p>
                        <p>Failed: ${metrics.requests.failed}</p>
                        <p>Avg Response: ${metrics.requests.avgResponseTime.toFixed(2)}ms</p>
                    </div>
                    
                    <div class="metric-card">
                        <h4>üöÄ Performance</h4>
                        <p>RPS: ${metrics.performance.requestsPerSecond.toFixed(2)}</p>
                        <p>Error Rate: ${metrics.performance.errorRate.toFixed(2)}%</p>
                        <p>P95: ${metrics.performance.p95ResponseTime}ms</p>
                        <p>P99: ${metrics.performance.p99ResponseTime}ms</p>
                    </div>
                    
                    <div class="metric-card">
                        <h4>üíæ System</h4>
                        <p>CPU: ${metrics.system.cpuUsage.toFixed(2)}</p>
                        <p>Memory: ${(metrics.system.memoryUsage.heapUsed / 1024 / 1024).toFixed(2)} MB</p>
                        <p>Uptime: ${(process.uptime ? process.uptime() : 'N/A')}s</p>
                    </div>
                `;
            } catch (error) {
                showResults(`<h3>‚ùå Error getting metrics:</h3><p>${error.message}</p>`);
            }
        }
        
        function showLoading(message) {
            document.getElementById('results').innerHTML = `<p>‚è≥ ${message}</p>`;
        }
        
        function showResults(html) {
            document.getElementById('results').innerHTML = html;
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('metrics').innerHTML = '';
        }
        
        // Auto-refresh metrics every 10 seconds
        setInterval(getMetrics, 10000);
        
        // Initial load
        getMetrics();
    </script>
</body>
</html>
